# DocAgent - 企业级文档问答系统

## 📖 项目简介

**DocAgent** 是一个基于 RAG (Retrieval Augmented Generation) 技术的企业级文档问答系统。它能够理解企业内部的各种文档（PDF、Word、Excel、PPT等），并像资深员工一样回答相关问题，所有回答都有明确的文档来源依据。

### 核心价值

- 🎯 **精准回答，不瞎编** - 所有回答都有明确的文档来源和页码引用
- 🧠 **智能检索** - 基于向量检索技术，快速找到最相关的文档片段
- 🔄 **自动更新** - 支持文档版本控制和增量更新，知识库持续更新
- 🔐 **安全可控** - 支持私有化部署，企业数据不出内网
- 📊 **可审计** - 完整的对话记录、审核日志和敏感内容检测

---

## 🏗️ 项目架构

### 技术栈

#### 后端
- **Web框架**: FastAPI 0.121.1
- **数据库**: PostgreSQL (SQLAlchemy 2.0)
- **缓存**: Redis
- **任务队列**: Celery + Celery Beat
- **向量数据库**: FAISS
- **对象存储**: MinIO
- **AI模型**: 
  - 通义千问 (DashScope) - 已配置并优先使用
  - OpenAI GPT-4
  - Ollama (本地模型)
  - 支持多模型调度和Fallback机制

#### 前端
- **框架**: Vue 3
- **UI组件**: Element Plus
- **状态管理**: Pinia
- **路由**: Vue Router
- **图表**: ECharts
- **构建工具**: Vite

### 项目结构

```
docagent/
├── backend/                 # 后端服务
│   ├── app/
│   │   ├── api/            # API路由
│   │   │   ├── auth.py           # 认证相关
│   │   │   ├── conversations.py  # 对话管理
│   │   │   ├── files.py          # 文件管理
│   │   │   ├── dashboard.py      # 仪表盘
│   │   │   ├── feedback.py       # 用户反馈
│   │   │   ├── review.py         # 内容审核
│   │   │   ├── prompt_templates.py # Prompt模板
│   │   │   └── ...
│   │   ├── models/        # 数据模型
│   │   │   ├── user.py           # 用户模型
│   │   │   ├── file.py           # 文件模型
│   │   │   ├── conversation.py  # 对话模型
│   │   │   ├── message.py       # 消息模型
│   │   │   ├── organization.py  # 组织模型
│   │   │   ├── role.py          # 角色权限模型
│   │   │   └── ...
│   │   ├── services/      # 业务服务
│   │   │   ├── rag_service.py          # RAG核心服务
│   │   │   ├── model_orchestrator.py   # 模型调度器
│   │   │   ├── vector_service.py       # 向量检索
│   │   │   ├── embedding_service.py    # 向量化
│   │   │   ├── document_parser.py      # 文档解析
│   │   │   ├── chunking_service.py     # 文档切片
│   │   │   ├── security_service.py     # 安全检测
│   │   │   ├── cache_service.py        # 缓存服务
│   │   │   └── ...
│   │   ├── tasks/         # 异步任务
│   │   │   ├── celery_app.py      # Celery配置
│   │   │   ├── document_tasks.py  # 文档处理任务
│   │   │   ├── refresh_tasks.py   # 文档刷新任务
│   │   │   └── scheduled_tasks.py # 定时任务
│   │   ├── database/      # 数据库
│   │   ├── utils/         # 工具函数
│   │   ├── config.py      # 配置管理
│   │   └── main.py        # 应用入口
│   ├── database/          # 数据库脚本
│   ├── tests/             # 测试用例
│   └── requirements.txt   # Python依赖
│
├── frontend/              # 前端服务
│   ├── src/
│   │   ├── views/        # 页面组件
│   │   │   ├── Chat.vue          # 对话界面
│   │   │   ├── Files.vue         # 文件管理
│   │   │   ├── Conversations.vue # 对话历史
│   │   │   ├── Dashboard.vue     # 数据仪表盘
│   │   │   ├── Admin.vue         # 管理界面
│   │   │   ├── Review.vue        # 审核界面
│   │   │   └── ...
│   │   ├── services/     # API服务
│   │   ├── stores/       # 状态管理
│   │   ├── router/       # 路由配置
│   │   └── layouts/      # 布局组件
│   └── package.json
│
├── docker-compose.yml     # Docker编排
├── nginx/                 # Nginx配置
└── Makefile              # 构建脚本
```

---

## ✨ 核心功能

### 1. 📚 文档管理

#### 支持的文档格式
- ✅ PDF
- ✅ Word (.docx)
- ✅ Excel (.xlsx)
- ✅ PowerPoint (.pptx)
- ✅ 纯文本 (.txt)
- ✅ Markdown (.md)
- ✅ HTML

#### 文档处理流程
1. **上传** → 文件存储到 MinIO
2. **解析** → 提取文本内容（支持分页）
3. **切片** → 智能切分为 800 tokens 的片段（重叠 200 tokens）
4. **向量化** → 生成 embedding 向量
5. **索引** → 存储到 FAISS 向量数据库

#### 文档版本控制
- ✅ 支持文档版本管理
- ✅ 增量更新（只更新变化部分）
- ✅ 定时自动刷新（每天凌晨2点）
- ✅ 版本历史追踪

### 2. 🤖 智能问答 (RAG)

#### RAG 流程
1. **问题向量化** → 将用户问题转换为向量
2. **向量检索** → 在 FAISS 中检索 Top-N 相关片段
3. **相似度过滤** → 过滤低相似度内容（阈值 0.75）
4. **上下文构建** → 结合对话历史构建 Prompt
5. **LLM 生成** → 调用大模型生成答案
6. **来源标注** → 标注每个答案的来源文档和页码

#### 返回格式
```json
{
  "answer": "根据公司政策，超过7天但未严重损坏的商品可以退为额度券...",
  "source": [
    {
      "doc": "售后政策V3.2.pdf",
      "file_id": 123,
      "page": 7,
      "paragraph": "超过7天但未严重损坏...",
      "similarity": 0.89,
      "relevance_score": 89
    }
  ],
  "confidence": 0.89,
  "confidence_level": "high",
  "evidence_count": 5
}
```

### 3. 🎛️ 模型调度器

#### 支持的模型
- ✅ **通义千问** (DashScope) - 已配置，优先使用
  - qwen-turbo
  - qwen-plus
  - qwen-max
- ✅ OpenAI GPT-4
- ✅ Azure OpenAI
- ✅ Ollama (本地模型)

#### 核心特性
- ✅ **多模型支持** - 可同时配置多个模型
- ✅ **智能调度** - 根据任务类型选择合适模型
- ✅ **Fallback机制** - 主模型失败自动切换备用模型
- ✅ **速率控制** - 每个模型独立的速率限制
- ✅ **健康监控** - 实时监控模型可用性和错误率

### 4. 🔐 权限与安全

#### 权限体系
- ✅ **角色系统** - superuser/admin/auditor/user
- ✅ **组织隔离** - 多租户支持，数据隔离
- ✅ **JWT认证** - 安全的Token认证机制
- ✅ **API权限控制** - 基于角色的API访问控制

#### 安全功能
- ✅ **敏感词检测** - 自动检测政治、歧视、成人、暴力、商业机密等敏感内容
- ✅ **风险等级评估** - critical/high/medium/low 四级风险
- ✅ **自动屏蔽** - 高风险内容自动屏蔽
- ✅ **审核系统** - 支持人工审核AI回答
- ✅ **审计日志** - 完整的操作审计记录

### 5. 📊 数据仪表盘

#### 统计指标
- ✅ 日调用次数 / 成功率 / 平均延迟
- ✅ Top 问题榜单（带满意度）
- ✅ 模型调用花费统计（tokens + 估算成本）
- ✅ 用户活跃度（对话数、消息数、最后活跃时间）
- ✅ 敏感内容检测率
- ✅ 缓存命中率
- ✅ 系统健康状态

#### 可视化
- ✅ ECharts 图表展示调用趋势
- ✅ 敏感内容检测统计图
- ✅ 实时系统健康状态
- ✅ 自动刷新（每5分钟）

### 6. 💬 对话管理

#### 功能特性
- ✅ **多轮对话** - 支持上下文理解
- ✅ **对话历史** - 完整的对话记录保存
- ✅ **流式输出** - 实时流式返回答案
- ✅ **导出功能** - 支持导出对话记录（Markdown/PDF）
- ✅ **反馈系统** - 用户可对回答进行评分和反馈

### 7. 🎨 Prompt 模板管理

#### 模板类别
- ✅ 客服版 (customer_service)
- ✅ 法务版 (legal)
- ✅ 培训版 (training)
- ✅ 通用版 (general)
- ✅ 技术版 (technical)
- ✅ 销售版 (sales)

#### 模板功能
- ✅ 参数化配置（temperature, max_tokens等）
- ✅ 变量定义和Few-shot示例
- ✅ 模板版本管理
- ✅ 使用统计和评分

### 8. 🔄 异步任务系统

#### Celery 任务
- ✅ **文档处理** - 异步处理大文件，避免阻塞
- ✅ **文档刷新** - 定时刷新文档，更新知识库
- ✅ **缓存清理** - 定期清理过期缓存
- ✅ **统计报告** - 生成每日统计报告

#### 定时任务 (Celery Beat)
- ✅ 每天凌晨2点自动刷新所有文档
- ✅ 每小时清理过期缓存
- ✅ 每天凌晨1点生成统计报告

### 9. 💾 缓存系统

#### 缓存策略
- ✅ **热问句缓存** - 相似问题直接返回上次结果
- ✅ **向量召回结果缓存** - 高频QA缓存
- ✅ **用户Session管理** - Redis存储用户会话
- ✅ **速率限制** - 防止API滥用

#### 效果
- 减少模型调用成本 30%+
- 响应速度提升 50%+

---

## 🚀 快速开始

### 环境要求

- Python 3.11+
- Node.js 16+
- PostgreSQL 15+
- Redis 7+
- Docker & Docker Compose (可选)

### 安装步骤

#### 1. 克隆项目
```bash
git clone <repository-url>
cd docagent
```

#### 2. 后端配置

```bash
cd backend

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
cp .env.example .env
# 编辑 .env 文件，配置数据库、Redis、API Key等
```

#### 3. 前端配置

```bash
cd frontend

# 安装依赖
npm install

# 配置环境变量（如需要）
# 编辑 vite.config.js 中的 API 地址
```

#### 4. 启动服务

**方式一：使用 Docker Compose**
```bash
docker-compose up -d
```

**方式二：手动启动**

后端：
```bash
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

前端：
```bash
cd frontend
npm run dev
```

Celery Worker：
```bash
cd backend
celery -A app.tasks.celery_app worker --loglevel=info
```

Celery Beat：
```bash
cd backend
celery -A app.tasks.celery_app beat --loglevel=info
```

### 访问地址

- 前端界面: http://localhost:5173
- 后端API: http://localhost:8000
- API文档: http://localhost:8000/docs
- MinIO控制台: http://localhost:9001

---

## 📝 配置说明

### 环境变量配置 (.env)

```env
# ========== 应用配置 ==========
APP_NAME=DocAgent
ENVIRONMENT=development
DEBUG=True

# ========== 数据库配置 ==========
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=docagent
POSTGRES_USER=docagent
POSTGRES_PASSWORD=docagent_password

# ========== Redis 配置 ==========
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# ========== 通义千问配置 ==========
TONGYI_API_KEY=sk-your-api-key
TONGYI_MODEL=qwen-turbo

# ========== LLM 配置 ==========
LLM_PROVIDER=tongyi
LLM_MODEL=qwen-turbo
LLM_TEMPERATURE=0.1
LLM_MAX_TOKENS=2000

# ========== OpenAI 配置（可选）==========
OPENAI_API_KEY=sk-your-openai-key
OPENAI_API_BASE=https://api.openai.com/v1

# ========== 对象存储配置 ==========
S3_ENDPOINT=http://localhost:9000
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
S3_BUCKET=docagent-files

# ========== 向量数据库配置 ==========
VECTOR_DB_TYPE=faiss
VECTOR_DB_PATH=/app/data/faiss_index

# ========== 检索配置 ==========
RETRIEVAL_TOP_N=20
RETRIEVAL_TOP_K=5
SIMILARITY_THRESHOLD=0.75

# ========== 知识更新配置 ==========
REFRESH_INTERVAL_HOURS=24
ENABLE_AUTO_REFRESH=False
INCREMENTAL_UPDATE_THRESHOLD=0.5
```

---

## 🔌 API 接口

### 认证相关
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `GET /api/auth/me` - 获取当前用户信息
- `POST /api/auth/logout` - 用户登出

### 文件管理
- `POST /api/files/` - 上传文件
- `GET /api/files/` - 获取文件列表
- `GET /api/files/{file_id}` - 获取文件详情
- `DELETE /api/files/{file_id}` - 删除文件
- `GET /api/files/{file_id}/status` - 获取文件处理状态

### 对话管理
- `POST /api/conversations/` - 创建对话
- `GET /api/conversations/` - 获取对话列表
- `GET /api/conversations/{conversation_id}` - 获取对话详情
- `POST /api/conversations/{conversation_id}/messages` - 发送消息
- `GET /api/conversations/{conversation_id}/messages` - 获取消息列表
- `DELETE /api/conversations/{conversation_id}` - 删除对话
- `GET /api/conversations/{conversation_id}/export` - 导出对话

### 用户反馈
- `POST /api/feedback/messages/{message_id}` - 提交反馈
- `GET /api/feedback/messages/{message_id}` - 获取反馈
- `GET /api/feedback/stats/org` - 获取组织反馈统计
- `GET /api/feedback/stats/daily` - 获取每日反馈统计

### 管理功能
- `GET /api/dashboard/overview` - 仪表盘概览
- `GET /api/dashboard/call-statistics` - 调用统计
- `GET /api/dashboard/top-questions` - 热门问题
- `GET /api/admin/stats` - 系统统计

### Prompt模板
- `POST /api/prompt-templates/` - 创建模板
- `GET /api/prompt-templates/` - 获取模板列表
- `GET /api/prompt-templates/{id}` - 获取模板详情
- `PUT /api/prompt-templates/{id}` - 更新模板
- `DELETE /api/prompt-templates/{id}` - 删除模板
- `POST /api/prompt-templates/{id}/render` - 渲染模板

### 内容审核
- `POST /api/review/messages` - 审核消息
- `GET /api/review/messages` - 获取待审核消息
- `GET /api/review/quality-report` - 质量报告

完整的API文档可在 http://localhost:8000/docs 查看。

---

## 📊 已实现功能清单

### ✅ 核心功能

- [x] 多格式文档解析（PDF、Word、Excel、PPT、TXT、Markdown、HTML）
- [x] 文档智能切片和向量化
- [x] 向量检索（FAISS）
- [x] RAG问答系统
- [x] 多模型支持（通义千问、OpenAI、Ollama）
- [x] 模型调度器和Fallback机制
- [x] 流式输出
- [x] 对话历史管理
- [x] 文档版本控制
- [x] 增量更新机制
- [x] 定时任务（Celery + Celery Beat）
- [x] Redis缓存系统
- [x] 用户认证和授权（JWT）
- [x] 角色权限系统
- [x] 组织多租户支持
- [x] 敏感词检测
- [x] 内容审核系统
- [x] 用户反馈系统
- [x] 数据仪表盘
- [x] Prompt模板管理
- [x] 对话导出功能
- [x] 审计日志
- [x] 系统健康监控

### ⚠️ 部分实现

- [ ] 文档级权限控制（目前只有组织级隔离）
- [ ] 点击查看原文功能（后端有数据，前端缺少交互）
- [ ] 审核工作台UI（后端有API，前端需要完善）
- [ ] OCR支持（图片扫描件识别）

### ❌ 未实现

- [ ] 数据源同步（钉钉、企业微信、飞书、ERP、CRM）
- [ ] 分角色语气（根据用户角色调整回答风格）
- [ ] 快捷动作（自动生成回复语、创建工单）
- [ ] 多模态理解（图片内容理解）
- [ ] K8S部署配置
- [ ] 数据加密和PII脱敏

---

## 🎯 核心特性详解

### 1. RAG 检索增强生成

系统采用经典的 RAG 架构：

1. **文档预处理**
   - 文档解析 → 文本提取
   - 智能切片 → 800 tokens/片段，200 tokens重叠
   - 向量化 → 使用 embedding 模型生成向量
   - 索引存储 → FAISS 向量数据库

2. **检索阶段**
   - 问题向量化
   - 相似度检索（Top-N）
   - 相似度过滤（阈值 0.75）
   - 上下文构建

3. **生成阶段**
   - Prompt构建（包含检索到的上下文）
   - LLM生成答案
   - 来源标注
   - 置信度评估

### 2. 模型调度器

`ModelOrchestrator` 提供智能模型调度：

- **多模型支持**: 可同时配置多个模型提供商
- **任务类型路由**: 根据任务类型（QA/摘要/提取/翻译）选择合适模型
- **优先级机制**: 按优先级尝试可用模型
- **Fallback机制**: 主模型失败自动切换备用模型
- **速率控制**: 每个模型独立的速率限制（滑动窗口）
- **健康监控**: 实时监控模型状态，自动暂停不可用模型

### 3. 知识更新机制

- **版本控制**: 文档版本号、上一版本ID、是否最新版本
- **增量更新**: 智能检测变化部分，只更新改动的chunk
- **定时刷新**: Celery Beat 每天凌晨2点自动刷新
- **手动刷新**: 支持手动触发文档刷新

### 4. 安全与审核

- **敏感词检测**: 多类别敏感词库（政治/歧视/成人/暴力/商业机密）
- **风险等级**: critical/high/medium/low 四级评估
- **自动屏蔽**: 高风险内容自动屏蔽
- **人工审核**: 审核员可审核AI回答
- **审计日志**: 完整的操作记录

---

## 📈 性能优化

### 已实现的优化

1. **Redis缓存层**
   - 热问句缓存
   - 向量召回结果缓存
   - 减少模型调用成本 30%+

2. **异步任务处理**
   - Celery异步处理大文件
   - 避免阻塞主线程
   - 提升响应速度

3. **增量更新**
   - 只更新变化部分
   - 减少embedding成本
   - 提升更新效率

4. **模型调度器**
   - 智能Fallback
   - 速率控制
   - 防止API超限

5. **数据库优化**
   - 索引优化
   - 查询优化
   - 连接池管理

---

## 🧪 测试

### 测试覆盖

- ✅ 单元测试 (`tests/test_unit_*.py`)
- ✅ API测试 (`tests/test_api.py`)
- ✅ 集成测试 (`tests/test_integration_e2e.py`)
- ✅ 压力测试 (`tests/test_stress_load.py`)
- ✅ 边界测试 (`tests/test_edge_cases.py`)

### 运行测试

```bash
cd backend
pytest tests/
```

---

## 🐳 Docker 部署

### 使用 Docker Compose

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 服务说明

- `backend` - 后端API服务
- `celery-worker` - Celery异步任务处理
- `frontend` - 前端服务
- `postgres` - PostgreSQL数据库
- `redis` - Redis缓存
- `minio` - MinIO对象存储
- `nginx` - Nginx反向代理

---

## 🔧 开发指南

### 代码结构

- **API层** (`app/api/`) - 处理HTTP请求，参数验证
- **服务层** (`app/services/`) - 业务逻辑实现
- **模型层** (`app/models/`) - 数据库模型定义
- **任务层** (`app/tasks/`) - 异步任务定义

### 添加新功能

1. **添加API端点**: 在 `app/api/` 中创建新的路由文件
2. **实现业务逻辑**: 在 `app/services/` 中实现服务类
3. **定义数据模型**: 在 `app/models/` 中定义模型
4. **注册路由**: 在 `app/api/__init__.py` 中注册新路由

---

## 📚 相关文档

- [需求实现文档](backend/README_IMPLEMENTATION.md) - 详细的功能实现说明
- [API文档](http://localhost:8000/docs) - 交互式API文档
- [数据库迁移脚本](backend/database/migrations/) - 数据库结构变更

---

## 🛣️ 未来规划

### 短期（1-2个月）
- [ ] 完善文档级权限控制
- [ ] 增强前端交互（点击查看原文）
- [ ] 完善审核工作台UI
- [ ] OCR支持（图片扫描件识别）

### 中期（3-6个月）
- [ ] 数据源集成（钉钉/企业微信/飞书/ERP/CRM）
- [ ] 分角色语气功能
- [ ] 快捷动作（自动生成回复语、创建工单）
- [ ] 知识图谱增强

### 长期（6-12个月）
- [ ] 多模态支持（图片/视频理解）
- [ ] K8S部署配置
- [ ] 数据加密和PII脱敏
- [ ] LLM Agent扩展

---

## 📄 许可证

详见 [LICENSE](LICENSE) 文件

---

## 👥 贡献

欢迎提交 Issue 和 Pull Request！

---

## 📞 联系方式

如有问题或建议，请联系开发团队。

---

**最后更新**: 2024年

